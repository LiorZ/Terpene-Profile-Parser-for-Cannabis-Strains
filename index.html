<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title id="title">StrainFinder</title>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<script id="jsonloader" type="text/javascript" src="results.json"></script>
		<style type="text/css">
			.floatleft {
				float: left;
			}

			#searchwrapper {
				display: inline-block;
			}
			#searchform fieldset {
				display: inline-block;
			}
			#sampleTypes, #databases {
				list-style-type: none;
				padding-left: 0;
			}

			#resultswrapper {
				display: inline-block;
				padding-left: 42px;
			}
			#results,#results td:nth-of-type(1),#results td:nth-of-type(3),#results td:nth-of-type(4),#results td:nth-of-type(5),#results tr {
				border: 1px solid black;
				border-collapse: collapse;
			}
			#results td:nth-of-type(1) {
				border: none;
			}
			#results thead {
				background-color: rgb(222,222,222);
			}
			#results .valuecolumn {
				/*text-shadow: 1px 1px 2px black, 0 0 1em white, 0 0 0.2em white;*/
				/*text-shadow: 0 0 1em white, 0 0 1em white, 0 0 1em white, 0 0 0.2em white, 0 0 0.2em white;*/
				background-color: rgba(255,255,255,0.75);
			}
			#graph {
				display: inline-block;
			}
			.graphcell {
				border: none !important;
			}
		</style>
	</head>
	<body>
		<div id="GUI">
			<div id="searchwrapper" class="floatleft">
				<form id="searchform" action="." onsubmit="return load_sample_data(this);">
					<input type="submit" value="Search"><br>

					<label for="search">Sample Name:</label>
					<input type="search" name="search" id="search" autofocus="">
					<label for="exactmatch">Exact Match?</label>
					<input type="checkbox" name="exactmatch">

					<div>
						<fieldset>
							<legend>Sample Types:</legend>
							<ul id="sampleTypes">
							</ul>
						</fieldset>
					</div>
					<div>
						<fieldset>
							<legend>Databases:</legend>
							<ul id="databases">
							</ul>
							<input type="file" name="fileUploader" accept="application/json, .json, .JSON" onchange="return changeHandler(this.files);">
						</fieldset>
					</div>
					<input type="submit" value="Search">
				</form>
			</div>
			<div id="resultswrapper">
				<table id="results">
					<caption></caption>
					<thead>
						<tr>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
			<svg id="graph" xmlns="http://www.w3.org/2000/svg"
				width="800" height="300">
			</svg>
		</div>
	</body>
	<script type="text/javascript">
		/*
		TODO:
			mobile friendly
			simple
			most relevant to least relevant

			big search field
			terpenes sort by most important ones
			sample type: group by processed/unprocessed
				flower
				processed
					edible
					concentrate
		*/
		function changeHandler(files) {
			for (var i = 0, file; file = files[i]; i++) {
				if (file.type!="application/json") {
					continue;
				}
				var reader = new FileReader();
				reader.onload = function(event) {
					var newDatabaseString = event.target.result;
					if (newDatabaseString.startsWith("databasesContainer=")) {
						newDatabaseString = newDatabaseString.substr(19);
					}
					var newDatabasesContainer = JSON.parse(newDatabaseString);
					database_imports++;
					for (const databaseName of Object.keys(newDatabasesContainer.databases)) {
						addDatabaseItem("import"+database_imports.toString()+"_"+databaseName, "Imported: "+databaseName);
						databasesContainer.databases["import"+database_imports.toString()+"_"+databaseName] = newDatabasesContainer.databases[databaseName];

						// sample type list
						Object.keys(newDatabasesContainer.databases[databaseName]).forEach(function(newSampleType){
							addSampletype(newSampleType);
						})

						// terpenes
						newDatabasesContainer.terpenes.forEach(function(newTerpene){
							if (terpenes.indexOf(newTerpene) == -1) {
								terpenes.push(newTerpene);
							}
						})
					}
				}
				reader.readAsText(file);
			}
			return false;
		}
		function addDatabaseItem(identifier, label) {
			var databaseListItem = document.createElement("li");
			var databaseInput = document.createElement("input");
			databaseInput.type = "checkbox";
			databaseInput.name = "database_" + identifier;
			databaseInput.id = "database_" + identifier;
			databaseInput.addEventListener("click", updateDatabaseCheckboxes);
			databaseListItem.appendChild(databaseInput);
			var databaseLabel = document.createElement("label");
			databaseLabel.htmlFor = "database_" + identifier;
			databaseLabel.innerText = label;
			databaseListItem.appendChild(databaseLabel);
			elem_databaseList.appendChild(databaseListItem);
		}
		function addSampletype(sampleType) {
			if (!sampleTypes.includes(sampleType)) {
				sampleTypes.push(sampleType);
				var li = document.createElement("li");
				var input = document.createElement("input");
				input.type = "checkbox";
				input.name = "type_"+sampleType;
				input.id = "type_"+sampleType;
				input.addEventListener("click", updateTypeCheckboxes);
				li.appendChild(input);
				var label = document.createElement("label");
				label.htmlFor = "type_"+sampleType;
				label.innerText = sampleType;
				li.appendChild(label);
				elem_sampleTypes.appendChild(li);
			}
		}

		var elem_form = document.getElementById("searchform");
		var elem_databaseList = document.getElementById("databases");
		var elem_sampleTypes = document.getElementById("sampleTypes");
		var elem_resultsTable = document.getElementById("results");
		var elem_graph = document.getElementById("graph");

		var terpenes = databasesContainer.terpenes;
		var sampleTypes = [];
		var database_imports = 0;

		// available databases list
		for (const databaseName of Object.keys(databasesContainer.databases)) {
			addDatabaseItem(databaseName, databaseName);
			// sample type list
			Object.keys(databasesContainer.databases[databaseName]).forEach(function(newSampleType){
				addSampletype(newSampleType);
			})
		}
		updateDatabaseCheckboxes();
		updateTypeCheckboxes();

		function updateTypeCheckboxes() {
			var anyChecked = false;
			document.querySelectorAll("#sampleTypes>li>input[type='checkbox']")
			.forEach(function(typeElem){
				if (typeElem.checked) {
					anyChecked = true;
				}
			})
			if (!anyChecked && elem_form.type_Flower!=undefined) {
				elem_form.type_Flower.checked = true;
			};
		}
		function updateDatabaseCheckboxes() {
			var anyChecked = false;
			document.querySelectorAll("#databases>li>input[type='checkbox']")
			.forEach(function(typeElem){
				if (typeElem.checked) {
					anyChecked = true;
				}
			})
			if (!anyChecked && elem_form.database_Psilabs!=undefined) {
				elem_form.database_Psilabs.checked = true;
			};
		}

		function toFixed(stringNumber, decimalPlaces) {
			var result = stringNumber.toFixed(decimalPlaces);
			var zeroMask = (0.0).toFixed(decimalPlaces);
			if (result == "-"+zeroMask) {
				return zeroMask
			} else {
				return result
			}
		}

        // "Terpene TOTAL": "1.0",

		//search by:
		//test uid
		//databases

		//sort by:
		// asc/desc
		//specific terpene
		function load_sample_data(elem_form) {
			var searchResults = [];
			var averages = {};
			var resultsNum = 0;
			var highestOverallValue = 0.0;
			var searchstring = elem_form.search.value.toLowerCase();
			elem_resultsTable.tBodies[0].innerHTML = "";
			elem_resultsTable.tHead.children[0].innerHTML = "";
			elem_graph.innerHTML = "";

			Object.keys(databasesContainer.databases).forEach(function(databaseName){
				if (elem_form["database_"+databaseName].checked) {
					var database = databasesContainer.databases[databaseName];
					for (const sampleType of Object.keys(database)) {
						if (elem_form["type_"+sampleType].checked) {
							database[sampleType].forEach(function(sample){
								var matched = false;
								if (elem_form.exactmatch.checked) {
									if (sample["Sample Name"].toLowerCase() == searchstring) {
										matched = true
									}
								} else {
									if (sample["Sample Name"].toLowerCase().includes(searchstring)) {
										matched = true
									}
								}
								if (matched) {
									resultsNum ++;
									terpenes.forEach(function(terpene){
										var currentTerpeneValue = parseFloat(sample[terpene]) || 0.0;
										if (!(terpene in averages)) {
											averages[terpene] = [currentTerpeneValue, currentTerpeneValue, currentTerpeneValue];
										} else {
											averages[terpene][0] += currentTerpeneValue;
											if (currentTerpeneValue < averages[terpene][1]) {
												averages[terpene][1] = currentTerpeneValue;
											}
											if (currentTerpeneValue > averages[terpene][2]) {
												averages[terpene][2] = currentTerpeneValue;
											}
										}
										if (currentTerpeneValue > highestOverallValue) {
											highestOverallValue = currentTerpeneValue;
										}

										if (!(terpene in searchResults)) {
											searchResults[terpene] = [currentTerpeneValue];
										} else {
											searchResults[terpene].push(currentTerpeneValue);
										}
									});
								}
							})
						}
					}
				}
			})

			if (resultsNum == 0) {
				elem_resultsTable.caption.innerText = "No results found";
			} else {
				// var bg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
				// bg.setAttributeNS(null, "height", "100%");
				// bg.setAttributeNS(null, "width", "100%");
				// bg.setAttributeNS(null, "fill", "red");
				// elem_graph.appendChild(bg);
				elem_resultsTable.caption.innerText = "Search Results for '"+searchstring+"' ("+resultsNum+" Sample"+(resultsNum==1?"":"s")+")";
				elem_resultsTable.tHead.children[0].innerHTML = "<td>Terpene</td><td>Graph</td>";
				elem_resultsTable.tBodies[0].innerText = "";
				terpenes.forEach(function(terpene){
					var average = averages[terpene][0]/resultsNum;
					averages[terpene][0] = average;
					// if (average > highestOverallValue) {
					// 	highestOverallValue = average;
					// }
				})
				var blub = 0;
				terpenes.forEach(function(terpene,terpeneIndex,array){
					var average = averages[terpene][0];
					var lowestValue = averages[terpene][1];
					var highestValue = averages[terpene][2];

					//table

					var row = document.createElement("tr");

					////terpene name
					var cell = document.createElement("td");
					cell.innerText = terpene;
					row.appendChild(cell);

					//graph-cells
					// var mappedGraphValue = Math.floor((100/highestOverallValue) * average);
					// for (var i=0; i<100; i++) {
					// 	var cell = document.createElement("td");
					// 	if (i <= mappedGraphValue) {
					// 		cell.style["background-color"] = "hsl(275, 80%, 25%)";
					// 	}
					// 	cell.className = "graphcell";
					// 	row.appendChild(cell);
					// }

					//graph-cells reimagined
					// (overlay all datapoints of this terpene onto each other with a transparency set to 100%/resultsNum)
					var mappedGraphValue = (100/highestOverallValue) * average;
					// mappedGraphValue = "100%";
					var cell = document.createElement("td");
					cell.className = "graphcell";
					var div = document.createElement("div");
					div.style["width"] = mappedGraphValue+"%";
					div.style["background-color"] = "red";
					div.style["display"] = "inline-table";
					cell.appendChild(div);
					// row.appendChild(cell);

					//graph-cells rereimagined
					// var cell = document.createElement("td");
					// cell.className = "graphcell";
					// cell.style["padding"] = 0;
					// cell.style["border-width"] = 0;
					// cell.style["border-bottom-width"] = 0;
					// // cell.style["border-right-width"] = 0;
					// row.appendChild(cell);
					// var canvas = document.createElement("canvas");
					// var cellWidth = cell.offsetWidth;
					// var cellHeight = cell.offsetHeight;
					// canvas.width = 53;
					// canvas.height = 23;
					// // canvas.width = cellWidth;
					// // canvas.height = cellHeight;
					// var ctx = canvas.getContext('2d');
					// //optional:
					// searchResults[terpene].sort()
					// searchResults[terpene].reverse();
					// ctx.fillStyle = "rgb(255, 0, 0)";
					// // ctx.fillStyle = "hsl(275, 80%, 25%)";
					// ctx.globalAlpha = 1/resultsNum;
					// searchResults[terpene].forEach(function(dataPoint){
					// 	// ctx.fillRect(0, 0, (53/highestOverallValue) * dataPoint, 23);
					// 	ctx.fillRect(0, 0, 53, 23);
					// });
					// cell.appendChild(canvas);

					////terpene amount
					var cell = document.createElement("td");
					// cell.style["background-color"] = "hsl("+(240-(120 * average/highestOverallValue))+",100%,50%)";
					cell.style["background-color"] = "hsl("+(240-(60 * average/highestOverallValue))+",100%,50%)";
					var span = document.createElement("span");
					span.className = "valuecolumn";
					span.innerText = toFixed(average, 1)+" %";
					cell.appendChild(span);
					row.appendChild(cell);

					////terpene lower variance
					// var cell = document.createElement("td");
					// cell.innerText = toFixed(lowestValue - average, 1)+" %";
					// row.appendChild(cell);

					// ////terpene upper variance
					// var cell = document.createElement("td");
					// cell.innerText = toFixed(highestValue - average, 1)+" %";
					// row.appendChild(cell);



					elem_resultsTable.tBodies[0].appendChild(row);

					/*
					// QUARANTINE

					//graph-cells
					var cell = document.createElement("td");
					// cell.style["background-color"] = "hsl(275, 60%, 25%)";
					// cell.style["background-color"] = "hsl(275, 80%, 25%)";
					cell.style["background-color"] = "hsl(275, 100%, 25%)";
					cell.colSpan = Math.floor((100/highestOverallValue) * average).toString();
					row.appendChild(cell);

					//graph
					// var bar = document.createElementNS("http://www.w3.org/2000/svg", "rect");
					// bar.setAttributeNS(null, "x", terpeneIndex * 25);
					// bar.setAttributeNS(null, "y", 300 - (300 * (average/highestOverallValue)));
					// bar.setAttributeNS(null, "height", 300 * (average/highestOverallValue));
					// bar.setAttributeNS(null, "width", 20);
					// bar.setAttributeNS(null, "fill", "blue");
					// elem_graph.appendChild(bar);
					*/
				})
			}
			var elem_pagetitle = document.getElementById("title");
			elem_pagetitle.text = "StrainFinder - '" + searchstring + "'";
			return false;
		}
	</script>
</html>
